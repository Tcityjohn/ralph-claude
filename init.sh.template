#!/bin/bash
# Ralph Session Initialization Script
# This script is auto-generated by the Session Initializer (Phase 0)
# It ensures reproducible environment setup across sessions
#
# Usage: ./init.sh
# Generated: [TIMESTAMP]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "Initializing Ralph session environment..."

# ─────────────────────────────────────────────────────────────
# 1. Git Setup
# ─────────────────────────────────────────────────────────────
if [ -f "prd.json" ]; then
  BRANCH=$(jq -r '.branchName // empty' prd.json)
  if [ -n "$BRANCH" ]; then
    CURRENT=$(git branch --show-current 2>/dev/null || echo "")
    if [ "$CURRENT" != "$BRANCH" ]; then
      echo "Switching to branch: $BRANCH"
      git checkout "$BRANCH" 2>/dev/null || git checkout -b "$BRANCH"
    else
      echo "Already on branch: $BRANCH"
    fi
  fi
fi

# ─────────────────────────────────────────────────────────────
# 2. Dependency Installation
# Uncomment the appropriate section for your project
# ─────────────────────────────────────────────────────────────

# Node.js (npm)
# if [ -f "package.json" ]; then
#   echo "Installing npm dependencies..."
#   npm install
# fi

# Node.js (yarn)
# if [ -f "yarn.lock" ]; then
#   echo "Installing yarn dependencies..."
#   yarn install
# fi

# Node.js (pnpm)
# if [ -f "pnpm-lock.yaml" ]; then
#   echo "Installing pnpm dependencies..."
#   pnpm install
# fi

# Python
# if [ -f "requirements.txt" ]; then
#   echo "Installing Python dependencies..."
#   pip install -r requirements.txt
# fi

# Python (Poetry)
# if [ -f "pyproject.toml" ]; then
#   echo "Installing Poetry dependencies..."
#   poetry install
# fi

# Rust
# if [ -f "Cargo.toml" ]; then
#   echo "Building Rust project..."
#   cargo build
# fi

# Go
# if [ -f "go.mod" ]; then
#   echo "Downloading Go modules..."
#   go mod download
# fi

# ─────────────────────────────────────────────────────────────
# 3. Build Step (if needed)
# Uncomment for your project
# ─────────────────────────────────────────────────────────────

# npm run build
# yarn build
# make build
# cargo build --release

# ─────────────────────────────────────────────────────────────
# 4. Verify Setup
# ─────────────────────────────────────────────────────────────

# Typecheck (uncomment for TypeScript projects)
# npm run typecheck || echo "Typecheck failed - check errors"

# Test collection (verify tests can run)
# npm test -- --passWithNoTests || echo "Test setup issue"

echo ""
echo "Environment initialized successfully."
echo "Ready for Ralph."
